name: Build and Deploy
on:
  push:
    branches:
      - static
jobs:
  build-and-deploy:
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        persist-credentials: false
    - name: Install Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: 1.6
    - name: Run Pluto notebooks
      run: julia -e '
        using Pkg;
        Pkg.activate(mktempdir());
        Pkg.add([
          Pkg.PackageSpec(name="PlutoSliderServer", version="0.2.1-0.2.6"),
        ]);
        import PlutoSliderServer;
        PlutoSliderServer.github_action("."; Export_cache_dir="pluto_state_cache");'
    - run: julia -e '
            using Pkg;
            Pkg.add(["NodeJS", "JSON", "Franklin"]);
            using NodeJS;
            cd("website");
            run(`$(npm_cmd()) install highlight.js`);
            using Franklin;
            optimize();
            "== Place rendered notebooks in the website folder ==";
            cp("../notebooks", "__site/notebooks");'
    - name: Build and Deploy
      uses: JamesIves/github-pages-deploy-action@releases/v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH: static
        FOLDER: website/__site